@page "/Demo/MaterialReceipt"
@namespace Demo.Web.Pages
@inherits MasterDetailPage<StoreHouseReceipt, MaterialReceipt>
<div style="margin:10px auto; width:95%">
    <CaspianForm @ref="MasterForm" Model="UpsertData" OnValidSubmit="@(async con =>
                                                            {
                                                                var result = await Task.FromResult(true);
                                                                return result;
                                                            })">
        <CaspianValidationValidator ValidatorType="typeof(StoreHouseReceiptService)" />
        <table style="width:100%">
            <tr>
                <td>
                    <label>تاریخ حواله</label>
                </td>
                <td>
                    <DatePicker @bind-Value="UpsertData.Date" />
                </td>
                <td>
                    <label>انبار</label>
                </td>
                <td colspan="2">
                    <ComboBox TValue="int" TEntity="StoreHouse" @bind-Value="UpsertData.StoreHouseId"
                              TextExpression="t => t.Title" ConditionExpression="t => t.ActiveType == ActiveType.Enable" />
                </td>
            </tr>
            <tr>
                <td>توضیحات</td>
                <td colspan="3">
                    <StringTextBox @bind-Value="UpsertData.Comment" MultiLine Rows="3" />
                </td>
                <td style="width:80px;">
                    <button style="width:60px" class="c-btn c-primary">ثبت</button>
                </td>
            </tr>
        </table>
       
    </CaspianForm>
    <DataGrid @ref="Grid" TEntity="MaterialReceipt" TableHeight="250" HidePageSize>
        <Columns Context="con">
            <GridColumn TEntity="MaterialReceipt" Field="t => t.Material.Title" Title="محصول">
                <EditTemplate>
                    <AutoComplete TValue="int" TEntity="Material" @bind-Value="con.Data.MaterialId" HideHeader AutoHide
                                  TextExpression="t => t.Title" Title="محصول"
                                  OnChange="async () =>
                                            {
                                                await UpdateMaterialReceipt(con.Data.MaterialId, con.Data);
                                            }">
                        <MaterialLookupPage TValue="int" />
                    </AutoComplete>
                </EditTemplate>
            </GridColumn>
            <GridColumn TEntity="MaterialReceipt" Field="t => t.QuantityMain">
                <EditTemplate>
                    <NumericTextBox @bind-Value="con.Data.QuantityMain" />
                </EditTemplate>
            </GridColumn>
            <GridColumn TEntity="MaterialReceipt" Field="t => t.Material.MainUnit.Title" Title="واحد اصلی">
                <Template>
                    <span>@(con.Data?.Material?.MainUnit?.Title)</span>
                </Template>
            </GridColumn>
            <GridColumn TEntity="MaterialReceipt" Field="t => t.QuantitySub">
                <EditTemplate>
                    @if (con.Data?.Material?.SubunitId != null)
                    {
                        <NumericTextBox @bind-Value="con.Data.QuantitySub" />
                    }
                </EditTemplate>
            </GridColumn>
            <GridColumn TEntity="MaterialReceipt" Field="t => t.Material.Subunit.Title" Title="واحد فرعی">
                <Template>
                    <span>@(con.Data?.Material?.Subunit?.Title)</span>
                </Template>
            </GridColumn>
            <GridCommandColumns TEntity="MaterialReceipt" />
        </Columns>
    </DataGrid>
</div>

@code
{
    async Task UpdateMaterialReceipt(int materialId, MaterialReceipt materialReceipt)
    {
        if (materialId > 0)
        {
            using var scope = CreateScope();
            materialReceipt.Material = await new MaterialService(scope).GetAll().Where(t => t.Id == materialId)
                .Include(t => t.MainUnit).Include(t => t.Subunit).SingleAsync();
        }
    }
}